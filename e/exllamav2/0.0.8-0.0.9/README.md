# Comparing `tmp/exllamav2-0.0.8-py3-none-any.whl.zip` & `tmp/exllamav2-0.0.9-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,75 +1,75 @@
-Zip file size: 91215 bytes, number of entries: 73
--rw-r--r--  2.0 unx      356 b- defN 23-Nov-12 07:51 exllamav2/__init__.py
--rw-r--r--  2.0 unx    26117 b- defN 23-Nov-12 07:51 exllamav2/attn.py
--rw-r--r--  2.0 unx     7879 b- defN 23-Nov-12 07:51 exllamav2/cache.py
--rw-r--r--  2.0 unx     1839 b- defN 23-Nov-12 07:51 exllamav2/compat.py
--rw-r--r--  2.0 unx     6329 b- defN 23-Nov-12 07:51 exllamav2/config.py
--rw-r--r--  2.0 unx     3452 b- defN 23-Nov-12 07:51 exllamav2/embedding.py
--rw-r--r--  2.0 unx     5910 b- defN 23-Nov-12 07:51 exllamav2/ext.py
--rw-r--r--  2.0 unx     5603 b- defN 23-Nov-12 07:51 exllamav2/linear.py
--rw-r--r--  2.0 unx     6501 b- defN 23-Nov-12 07:51 exllamav2/lora.py
--rw-r--r--  2.0 unx     7512 b- defN 23-Nov-12 07:51 exllamav2/mlp.py
--rw-r--r--  2.0 unx    23671 b- defN 23-Nov-12 07:51 exllamav2/model.py
--rw-r--r--  2.0 unx     3114 b- defN 23-Nov-12 07:51 exllamav2/model_init.py
--rw-r--r--  2.0 unx     3540 b- defN 23-Nov-12 07:51 exllamav2/module.py
--rw-r--r--  2.0 unx     2298 b- defN 23-Nov-12 07:51 exllamav2/rmsnorm.py
--rw-r--r--  2.0 unx    12003 b- defN 23-Nov-12 07:51 exllamav2/tokenizer.py
--rw-r--r--  2.0 unx     2367 b- defN 23-Nov-12 07:51 exllamav2/util.py
--rw-r--r--  2.0 unx       21 b- defN 23-Nov-12 07:51 exllamav2/version.py
--rw-r--r--  2.0 unx      199 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/config.h
--rw-r--r--  2.0 unx    28125 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/ext.cpp
--rw-r--r--  2.0 unx     1530 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cpp/quantize_func.cpp
--rw-r--r--  2.0 unx      446 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cpp/quantize_func.h
--rw-r--r--  2.0 unx    14725 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cpp/sampling.cpp
--rw-r--r--  2.0 unx     1807 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cpp/sampling.h
--rw-r--r--  2.0 unx      932 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cpp/util.h
--rw-r--r--  2.0 unx     4557 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/cache.cu
--rw-r--r--  2.0 unx      530 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/cache.cuh
--rw-r--r--  2.0 unx     1569 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/compat.cuh
--rw-r--r--  2.0 unx     7201 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/h_gemm.cu
--rw-r--r--  2.0 unx      447 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/h_gemm.cuh
--rw-r--r--  2.0 unx      935 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/lora.cu
--rw-r--r--  2.0 unx      463 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/lora.cuh
--rw-r--r--  2.0 unx     4293 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/matrix_view.cuh
--rw-r--r--  2.0 unx     7287 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/pack_tensor.cu
--rw-r--r--  2.0 unx      549 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/pack_tensor.cuh
--rw-r--r--  2.0 unx     5327 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_attn.cu
--rw-r--r--  2.0 unx     2018 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_attn.cuh
--rw-r--r--  2.0 unx     5372 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_gemm.cu
--rw-r--r--  2.0 unx      512 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_gemm.cuh
--rw-r--r--  2.0 unx    16616 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_gemm_kernel.cuh
--rw-r--r--  2.0 unx     6657 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_gemm_kernel_gptq.cuh
--rw-r--r--  2.0 unx    18225 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_matrix.cu
--rw-r--r--  2.0 unx     1256 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_matrix.cuh
--rw-r--r--  2.0 unx     4099 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_mlp.cu
--rw-r--r--  2.0 unx     1161 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/q_mlp.cuh
--rw-r--r--  2.0 unx     5208 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quantize.cu
--rw-r--r--  2.0 unx      831 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quantize.cuh
--rw-r--r--  2.0 unx     3329 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/rms_norm.cu
--rw-r--r--  2.0 unx      277 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/rms_norm.cuh
--rw-r--r--  2.0 unx     4016 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/rope.cu
--rw-r--r--  2.0 unx      366 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/rope.cuh
--rw-r--r--  2.0 unx     1925 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/util.cuh
--rw-r--r--  2.0 unx     2881 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quant/qdq_2.cuh
--rw-r--r--  2.0 unx     5782 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quant/qdq_3.cuh
--rw-r--r--  2.0 unx     5755 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quant/qdq_4.cuh
--rw-r--r--  2.0 unx     7342 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quant/qdq_5.cuh
--rw-r--r--  2.0 unx      958 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quant/qdq_6.cuh
--rw-r--r--  2.0 unx      643 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quant/qdq_8.cuh
--rw-r--r--  2.0 unx     1272 b- defN 23-Nov-12 07:51 exllamav2/exllamav2_ext/cuda/quant/qdq_util.cuh
--rw-r--r--  2.0 unx      235 b- defN 23-Nov-12 07:51 exllamav2/generator/__init__.py
--rw-r--r--  2.0 unx     4215 b- defN 23-Nov-12 07:51 exllamav2/generator/base.py
--rw-r--r--  2.0 unx     5963 b- defN 23-Nov-12 07:51 exllamav2/generator/sampler.py
--rw-r--r--  2.0 unx    13294 b- defN 23-Nov-12 07:51 exllamav2/generator/streaming.py
--rw-r--r--  2.0 unx      173 b- defN 23-Nov-12 07:51 exllamav2/generator/filters/__init__.py
--rw-r--r--  2.0 unx      592 b- defN 23-Nov-12 07:51 exllamav2/generator/filters/base.py
--rw-r--r--  2.0 unx     3319 b- defN 23-Nov-12 07:51 exllamav2/generator/filters/select.py
--rw-r--r--  2.0 unx      107 b- defN 23-Nov-12 07:51 exllamav2/server/__init__.py
--rw-r--r--  2.0 unx     1286 b- defN 23-Nov-12 07:51 exllamav2/server/websocket.py
--rw-r--r--  2.0 unx     7437 b- defN 23-Nov-12 07:51 exllamav2/server/websocket_actions.py
--rw-r--r--  2.0 unx     1035 b- defN 23-Nov-12 07:52 exllamav2-0.0.8.dist-info/LICENSE
--rw-r--r--  2.0 unx      400 b- defN 23-Nov-12 07:52 exllamav2-0.0.8.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Nov-12 07:52 exllamav2-0.0.8.dist-info/WHEEL
--rw-r--r--  2.0 unx       10 b- defN 23-Nov-12 07:52 exllamav2-0.0.8.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     6554 b- defN 23-Nov-12 07:52 exllamav2-0.0.8.dist-info/RECORD
-73 files, 340647 bytes uncompressed, 80715 bytes compressed:  76.3%
+Zip file size: 91417 bytes, number of entries: 73
+-rw-r--r--  2.0 unx      356 b- defN 23-Oct-15 17:33 exllamav2/__init__.py
+-rw-r--r--  2.0 unx    26117 b- defN 23-Oct-22 17:34 exllamav2/attn.py
+-rw-r--r--  2.0 unx     7879 b- defN 23-Oct-22 15:45 exllamav2/cache.py
+-rw-r--r--  2.0 unx     1839 b- defN 23-Oct-14 13:47 exllamav2/compat.py
+-rw-r--r--  2.0 unx     6329 b- defN 23-Nov-05 01:28 exllamav2/config.py
+-rw-r--r--  2.0 unx     3452 b- defN 23-Oct-22 18:11 exllamav2/embedding.py
+-rw-r--r--  2.0 unx     5910 b- defN 23-Nov-10 19:13 exllamav2/ext.py
+-rw-r--r--  2.0 unx     5603 b- defN 23-Oct-14 13:47 exllamav2/linear.py
+-rw-r--r--  2.0 unx     6501 b- defN 23-Oct-22 18:11 exllamav2/lora.py
+-rw-r--r--  2.0 unx     7512 b- defN 23-Oct-22 17:34 exllamav2/mlp.py
+-rw-r--r--  2.0 unx    23708 b- defN 23-Nov-21 03:04 exllamav2/model.py
+-rw-r--r--  2.0 unx     3114 b- defN 23-Oct-22 16:56 exllamav2/model_init.py
+-rw-r--r--  2.0 unx     3540 b- defN 23-Nov-05 01:22 exllamav2/module.py
+-rw-r--r--  2.0 unx     2298 b- defN 23-Nov-05 01:32 exllamav2/rmsnorm.py
+-rw-r--r--  2.0 unx    12003 b- defN 23-Nov-07 23:47 exllamav2/tokenizer.py
+-rw-r--r--  2.0 unx     2367 b- defN 23-Oct-14 13:43 exllamav2/util.py
+-rw-r--r--  2.0 unx       21 b- defN 23-Nov-22 04:45 exllamav2/version.py
+-rw-r--r--  2.0 unx      199 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/config.h
+-rw-r--r--  2.0 unx    28327 b- defN 23-Nov-21 06:28 exllamav2/exllamav2_ext/ext.cpp
+-rw-r--r--  2.0 unx     1530 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cpp/quantize_func.cpp
+-rw-r--r--  2.0 unx      446 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cpp/quantize_func.h
+-rw-r--r--  2.0 unx    15491 b- defN 23-Nov-21 06:31 exllamav2/exllamav2_ext/cpp/sampling.cpp
+-rw-r--r--  2.0 unx     1940 b- defN 23-Nov-21 05:30 exllamav2/exllamav2_ext/cpp/sampling.h
+-rw-r--r--  2.0 unx      932 b- defN 23-Oct-14 13:47 exllamav2/exllamav2_ext/cpp/util.h
+-rw-r--r--  2.0 unx     4557 b- defN 23-Oct-15 20:43 exllamav2/exllamav2_ext/cuda/cache.cu
+-rw-r--r--  2.0 unx      530 b- defN 23-Oct-15 19:19 exllamav2/exllamav2_ext/cuda/cache.cuh
+-rw-r--r--  2.0 unx     1569 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/compat.cuh
+-rw-r--r--  2.0 unx     7201 b- defN 23-Nov-10 19:13 exllamav2/exllamav2_ext/cuda/h_gemm.cu
+-rw-r--r--  2.0 unx      447 b- defN 23-Oct-14 13:47 exllamav2/exllamav2_ext/cuda/h_gemm.cuh
+-rw-r--r--  2.0 unx      935 b- defN 23-Oct-14 13:47 exllamav2/exllamav2_ext/cuda/lora.cu
+-rw-r--r--  2.0 unx      463 b- defN 23-Oct-14 13:47 exllamav2/exllamav2_ext/cuda/lora.cuh
+-rw-r--r--  2.0 unx     4293 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/matrix_view.cuh
+-rw-r--r--  2.0 unx     7287 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/pack_tensor.cu
+-rw-r--r--  2.0 unx      549 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/pack_tensor.cuh
+-rw-r--r--  2.0 unx     5327 b- defN 23-Oct-14 13:47 exllamav2/exllamav2_ext/cuda/q_attn.cu
+-rw-r--r--  2.0 unx     2018 b- defN 23-Oct-14 13:47 exllamav2/exllamav2_ext/cuda/q_attn.cuh
+-rw-r--r--  2.0 unx     5372 b- defN 23-Nov-10 19:13 exllamav2/exllamav2_ext/cuda/q_gemm.cu
+-rw-r--r--  2.0 unx      512 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/q_gemm.cuh
+-rw-r--r--  2.0 unx    16616 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/q_gemm_kernel.cuh
+-rw-r--r--  2.0 unx     6657 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/q_gemm_kernel_gptq.cuh
+-rw-r--r--  2.0 unx    18225 b- defN 23-Oct-28 18:26 exllamav2/exllamav2_ext/cuda/q_matrix.cu
+-rw-r--r--  2.0 unx     1256 b- defN 23-Oct-28 17:40 exllamav2/exllamav2_ext/cuda/q_matrix.cuh
+-rw-r--r--  2.0 unx     4099 b- defN 23-Oct-22 17:34 exllamav2/exllamav2_ext/cuda/q_mlp.cu
+-rw-r--r--  2.0 unx     1161 b- defN 23-Oct-14 13:47 exllamav2/exllamav2_ext/cuda/q_mlp.cuh
+-rw-r--r--  2.0 unx     5208 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quantize.cu
+-rw-r--r--  2.0 unx      831 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quantize.cuh
+-rw-r--r--  2.0 unx     3329 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/rms_norm.cu
+-rw-r--r--  2.0 unx      277 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/rms_norm.cuh
+-rw-r--r--  2.0 unx     4016 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/rope.cu
+-rw-r--r--  2.0 unx      366 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/rope.cuh
+-rw-r--r--  2.0 unx     1925 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/util.cuh
+-rw-r--r--  2.0 unx     2881 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quant/qdq_2.cuh
+-rw-r--r--  2.0 unx     5782 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quant/qdq_3.cuh
+-rw-r--r--  2.0 unx     5755 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quant/qdq_4.cuh
+-rw-r--r--  2.0 unx     7342 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quant/qdq_5.cuh
+-rw-r--r--  2.0 unx      958 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quant/qdq_6.cuh
+-rw-r--r--  2.0 unx      643 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quant/qdq_8.cuh
+-rw-r--r--  2.0 unx     1272 b- defN 23-Oct-14 13:43 exllamav2/exllamav2_ext/cuda/quant/qdq_util.cuh
+-rw-r--r--  2.0 unx      235 b- defN 23-Oct-14 13:47 exllamav2/generator/__init__.py
+-rw-r--r--  2.0 unx     4215 b- defN 23-Oct-27 00:01 exllamav2/generator/base.py
+-rw-r--r--  2.0 unx     6126 b- defN 23-Nov-21 06:27 exllamav2/generator/sampler.py
+-rw-r--r--  2.0 unx    13303 b- defN 23-Nov-18 06:36 exllamav2/generator/streaming.py
+-rw-r--r--  2.0 unx      173 b- defN 23-Oct-14 13:47 exllamav2/generator/filters/__init__.py
+-rw-r--r--  2.0 unx      592 b- defN 23-Oct-14 13:47 exllamav2/generator/filters/base.py
+-rw-r--r--  2.0 unx     3319 b- defN 23-Oct-14 13:47 exllamav2/generator/filters/select.py
+-rw-r--r--  2.0 unx      107 b- defN 23-Oct-14 13:47 exllamav2/server/__init__.py
+-rw-r--r--  2.0 unx     1286 b- defN 23-Oct-14 13:47 exllamav2/server/websocket.py
+-rw-r--r--  2.0 unx     7437 b- defN 23-Nov-08 07:56 exllamav2/server/websocket_actions.py
+-rw-r--r--  2.0 unx     1035 b- defN 23-Nov-22 06:31 exllamav2-0.0.9.dist-info/LICENSE
+-rw-r--r--  2.0 unx      406 b- defN 23-Nov-22 06:31 exllamav2-0.0.9.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Nov-22 06:31 exllamav2-0.0.9.dist-info/WHEEL
+-rw-r--r--  2.0 unx       10 b- defN 23-Nov-22 06:31 exllamav2-0.0.9.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     6554 b- defN 23-Nov-22 06:31 exllamav2-0.0.9.dist-info/RECORD
+73 files, 341963 bytes uncompressed, 80917 bytes compressed:  76.3%
```

## zipnote {}

```diff
@@ -198,23 +198,23 @@
 
 Filename: exllamav2/server/websocket.py
 Comment: 
 
 Filename: exllamav2/server/websocket_actions.py
 Comment: 
 
-Filename: exllamav2-0.0.8.dist-info/LICENSE
+Filename: exllamav2-0.0.9.dist-info/LICENSE
 Comment: 
 
-Filename: exllamav2-0.0.8.dist-info/METADATA
+Filename: exllamav2-0.0.9.dist-info/METADATA
 Comment: 
 
-Filename: exllamav2-0.0.8.dist-info/WHEEL
+Filename: exllamav2-0.0.9.dist-info/WHEEL
 Comment: 
 
-Filename: exllamav2-0.0.8.dist-info/top_level.txt
+Filename: exllamav2-0.0.9.dist-info/top_level.txt
 Comment: 
 
-Filename: exllamav2-0.0.8.dist-info/RECORD
+Filename: exllamav2-0.0.9.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## exllamav2/model.py

```diff
@@ -364,15 +364,15 @@
                         hidden_state = safe_move_tensor(hidden_state, _torch_device(current_device))
                         hidden_state = module.forward(hidden_state, cache = cache, attn_mask = attn_mask, past_len = past_len, loras = loras)
                         fail = False
 
                     except Exception as e:
 
                         test = 0
-                        if "CUDA out of memory" in str(e):
+                        if ("CUDA out of memory" in str(e)) or ("HIP out of memory" in str(e)):
                             fail = True  # Exception object will hold references to tensors so we can't free them here
                         else:
                             raise
 
                     # If we failed, roll back and advance to next device
 
                     if fail:
```

## exllamav2/version.py

```diff
@@ -1 +1 @@
-__version__ = "0.0.8"
+__version__ = "0.0.9"
```

## exllamav2/exllamav2_ext/ext.cpp

```diff
@@ -754,15 +754,16 @@
     float random,
     torch::Tensor output_tokens,    // shape [bsz, 1]
     torch::Tensor output_probs,     // shape [bsz, 1]
     torch::Tensor logit_filter,     // shape [bsz, vocab_size]
     bool mirostat,
     std::vector<float>& mirostat_mu,
     float mirostat_tau,
-    float mirostat_eta
+    float mirostat_eta,
+    float post_temperature
 )
 {
     TORCH_CHECK_DTYPE(logits, kFloat);
     TORCH_CHECK_DTYPE(output_tokens, kLong);
     TORCH_CHECK_DTYPE(output_probs, kFloat);
     TORCH_CHECK_DTYPE(logits, kFloat);
     TORCH_CHECK_DTYPE(logit_filter, kBool);
@@ -836,14 +837,19 @@
 
         if (mirostat)
         {
             num_candidates = mirostat_pre_cpu(num_candidates, temp_probs, temp_indices, mirostat_mu[i], mirostat_tau, mirostat_eta);
             normalize_cpu(num_candidates, temp_probs);
         }
 
+        if (post_temperature != 1.0f)
+        {
+            num_candidates = post_softmax_temperature(num_candidates, temp_probs, temp_indices, post_temperature);
+        }
+
         num_candidates = multinomial_cpu(num_candidates, temp_probs, temp_indices, random);
         output_tokens[i] = temp_indices[0];
         output_probs[i] = temp_probs[0];
 
         if (mirostat)
         {
             mirostat_mu[i] = mirostat_post_cpu(num_candidates, temp_probs, temp_indices, mirostat_mu[i], mirostat_tau, mirostat_eta);
```

## exllamav2/exllamav2_ext/cpp/sampling.cpp

```diff
@@ -99,14 +99,50 @@
 //            printf("%d, %f\n", i, output[i]);
 //            summ += output[i];
 //        }
 //    }
 //    printf("sum: %f\n", summ);
 }
 
+int post_softmax_temperature
+(
+    const int num_candidates,
+    float* temp_probs,
+    int* temp_indices,
+    float temperature
+)
+{
+//    printf("---- pre\n");
+//    for (int i = 0; i < num_candidates; ++i)
+//        DBGIF(i, temp_probs[i]);
+
+    float psum = 0.0f;
+    float itemp = 1.0f / temperature;
+    for (int i = 0; i < num_candidates; ++i)
+    {
+        float p = powf(temp_probs[i], itemp);
+        psum += p;
+        temp_probs[i] = p;
+    }
+
+    float ipsum = 1.0f / psum;
+    for (int i = 0; i < num_candidates; ++i)
+        temp_probs[i] *= ipsum;
+
+//    printf("---- post\n");
+//    DBGF(temperature);
+//    printf("----\n");
+//    for (int i = 0; i < num_candidates; ++i)
+//        DBGIF(i, temp_probs[i]);
+//    printf("\n");
+
+    return num_candidates;
+}
+
+
 void normalize_cpu
 (
     const int num_candidates,
     float* probs
 )
 {
     float sum = 0.0f;
@@ -502,17 +538,15 @@
     // Discard tokens with surprise greater than mu
 
     int nc = sort_descending(num_candidates, temp_probs, temp_indices, num_candidates);
 
     float target_prob = powf(2, -mu);
     int k = 1;
     for (; k < nc; k++)
-    {
-        if (-log2(temp_probs[k]) > mu) break;
-    }
+        if (temp_probs[k] < target_prob) break;
 
     //TIME_STOP;
 
     return k;
 }
 
 float mirostat_post_cpu
```

## exllamav2/exllamav2_ext/cpp/sampling.h

```diff
@@ -103,14 +103,22 @@
     float* temp_probs,
     int* temp_indices,
     float mirostat_mu,
     float mirostat_tau,
     float mirostat_eta
 );
 
+int post_softmax_temperature
+(
+    const int num_candidates,
+    float* temp_probs,
+    int* temp_indices,
+    float temperature
+);
+
 int multinomial_cpu
 (
     const int num_candidates,
     float* temp_probs,
     int* temp_indices,
     float random
 );
```

## exllamav2/generator/sampler.py

```diff
@@ -14,14 +14,16 @@
         temperature = 0.9
         top_k = 40
         top_p = 0.9
         min_p = 0
         tfs = 0
         typical = 0
 
+        temperature_last = False
+
         mirostat = False
         mirostat_tau = 1.5
         mirostat_eta = 0.1
         mirostat_mu = None  # (re)initialized from mirostat_tau on first sample
 
         token_bias = None
 
@@ -153,28 +155,29 @@
 
         batch_size = logits.shape[0]
 
         output_tokens = torch.empty((batch_size, 1), device = "cpu", dtype = torch.long)
         output_probs = torch.empty((batch_size, 1), device = "cpu", dtype = torch.float)
 
         m = ext_c.sample_basic(logits,
-                               settings.temperature,
+                               1.0 if settings.temperature_last else settings.temperature,
                                settings.top_k,
                                settings.top_p,
                                settings.min_p,
                                settings.tfs,
                                settings.typical,
                                random,
                                output_tokens,
                                output_probs,
                                logit_filter,
                                settings.mirostat,
                                settings.mirostat_mu if settings.mirostat else [],
                                settings.mirostat_tau,
-                               settings.mirostat_eta)
+                               settings.mirostat_eta,
+                               settings.temperature if settings.temperature_last else 1.0)
 
         if settings.mirostat: settings.mirostat_mu = m
 
         # Stop condition from filters
 
         end_filter = False
         if len(settings.filters) > 0 and output_tokens[0].item() in end_tokens: end_filter = True
```

## exllamav2/generator/streaming.py

```diff
@@ -326,15 +326,15 @@
             draft_gen_settings = gen_settings.greedy_clone()
             draft_sequence_ids = self.sequence_ids.clone()
             num_drafted_tokens = 0
 
             for k in range(self.num_speculative_tokens):
 
                 logits = self.draft_model.forward(draft_sequence_ids[:, -1:], self.draft_cache).float().cpu()
-                token, prob, _ = ExLlamaV2Sampler.sample(logits, draft_gen_settings, draft_sequence_ids, random.random(), self.tokenizer, prefix_token and k == 0)
+                token, prob, _ = ExLlamaV2Sampler.sample(logits, draft_gen_settings, draft_sequence_ids, random.random(), self.tokenizer, prefix_token if k == 0 else None)
 
                 if prob < self.speculative_prob_threshold:
                     self.draft_cache.current_seq_len -= 1
                     break
 
                 draft_sequence_ids = torch.cat((draft_sequence_ids, token), dim = 1)
                 num_drafted_tokens += 1
```

## Comparing `exllamav2-0.0.8.dist-info/LICENSE` & `exllamav2-0.0.9.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `exllamav2-0.0.8.dist-info/RECORD` & `exllamav2-0.0.9.dist-info/RECORD`

 * *Files 3% similar despite different names*

```diff
@@ -4,27 +4,27 @@
 exllamav2/compat.py,sha256=Q8KRx58kDdvy0BMFW8G8NXxXf3UKuIq6ZpHhcG35Z2U,1839
 exllamav2/config.py,sha256=W0Fdu7610fbcm-JZ_isMPGkYI2A5bWcP67If6TH7Pi8,6329
 exllamav2/embedding.py,sha256=eBdiUE4Aa33IG4iKci7x3bqJZDYAOHKeQqWSO4rxWpY,3452
 exllamav2/ext.py,sha256=xr-Q8sR6mCX0r85QpNYNdK1rFFLHvW5_1pjSUL9UMBo,5910
 exllamav2/linear.py,sha256=OFor-czZcc-6aAkMgcnz8gW3ADV8V_LVGogy3GaIRj8,5603
 exllamav2/lora.py,sha256=VJb_KAw3USthQzJyHFBFiCbjmx3bz_N4p5tV26_CLTg,6501
 exllamav2/mlp.py,sha256=ftwOpts586a24ztL6FxuLeKeDaGVkKKpELvXuobOK_o,7512
-exllamav2/model.py,sha256=EH3WgSXa8HJwyAdcPchOIEZERIasn_86xw8KzOT7JgM,23671
+exllamav2/model.py,sha256=A5QIpYMSs9oUKvJkEVqb8W0Cm9AdV2RwZPRZ2uNEPOw,23708
 exllamav2/model_init.py,sha256=WZ8IH-MIf6kLWynhOvD7orjvIQ7XbBIzrfPxoSZX3Ec,3114
 exllamav2/module.py,sha256=563fkAbV4oIok1s8q1A5T6PW8dkMAR_0dXc57qKLp5k,3540
 exllamav2/rmsnorm.py,sha256=jTffjioBn4xhSEHNZCQl8efZLYHBG0pmU4ts0wvET5k,2298
 exllamav2/tokenizer.py,sha256=TI7GalTdA7VRgLu-5pbFlpKvTITnbjPjb06z3eTxaY4,12003
 exllamav2/util.py,sha256=Zs8VXHT2AMoKCvaXJL5ekF5REJY-Uv23WzLTJURkWqQ,2367
-exllamav2/version.py,sha256=ICOxGt7ta-t2F9uXLMXVo-4VDYGM0IEvKPStCf0y8Rk,21
+exllamav2/version.py,sha256=i_8WJmpfvLpsjKXabWI0e47fVoWC1Es8pVboBDn2ORg,21
 exllamav2/exllamav2_ext/config.h,sha256=DY6caIYcx7GkOOvOKAtfSnJsGH2rA0lg3sYxOv5eU9U,199
-exllamav2/exllamav2_ext/ext.cpp,sha256=Y2U6imdsYxGj9LYpRmqr7yYn5IKmMtvz9P15LNhsUGI,28125
+exllamav2/exllamav2_ext/ext.cpp,sha256=mL7dGzeF8wFirPG8ewJxdeiYjbiooUjGv2f2ljRP32k,28327
 exllamav2/exllamav2_ext/cpp/quantize_func.cpp,sha256=ipl86qlITBUWStkg-vQCII8zeHRLloN0M2kfAe_xhg0,1530
 exllamav2/exllamav2_ext/cpp/quantize_func.h,sha256=8BCLrVByMrS_svOLvvQYENHRcWKVX2TuAUVEb-re72k,446
-exllamav2/exllamav2_ext/cpp/sampling.cpp,sha256=8MMNw0CT8yctEpxiDm5bNYBqC-5KopEbVZqHJdhIwNc,14725
-exllamav2/exllamav2_ext/cpp/sampling.h,sha256=_dNyvu-bqCpJ4dzd-k7mvdD5Ol2qpU8rBq9mQQqpfLY,1807
+exllamav2/exllamav2_ext/cpp/sampling.cpp,sha256=xgZfeC_L-46Ux2oelwb8lFOkXL2qZurPRTLs1mHpjt8,15491
+exllamav2/exllamav2_ext/cpp/sampling.h,sha256=bwDRITD7ioT26_q9l99X9_Lg2Mx7QK0R5NBFb2zQtrA,1940
 exllamav2/exllamav2_ext/cpp/util.h,sha256=AW2RP-ibBkwAOwHtnEoHqxLhov2CPZTG2HmZbbMHZ40,932
 exllamav2/exllamav2_ext/cuda/cache.cu,sha256=Bp7Jy0IOERdKUZfkO76Pdxro41TgLBMfNf5JnGKZwxw,4557
 exllamav2/exllamav2_ext/cuda/cache.cuh,sha256=85qweclsTLfkC6-MuvLQZE-ArFjr94QAmvmGaMYGdmU,530
 exllamav2/exllamav2_ext/cuda/compat.cuh,sha256=x99jKPqd6rzW4sPdAOhlrvh4kOq3VPFasa8DiEcov0s,1569
 exllamav2/exllamav2_ext/cuda/h_gemm.cu,sha256=knAatwocv8xr3Y4loTCgskIRwUgBJlEiMPw_gVe2cZU,7201
 exllamav2/exllamav2_ext/cuda/h_gemm.cuh,sha256=5MwIy3rv50FOaFqivffvyYBQnHup6d8zcb8lfIwRpBA,447
 exllamav2/exllamav2_ext/cuda/lora.cu,sha256=cJJR32u8mzfBqv2SJ-LxDQaUuacvPIrQ7M0BCsxRo-U,935
@@ -54,20 +54,20 @@
 exllamav2/exllamav2_ext/cuda/quant/qdq_4.cuh,sha256=2TP9bFuf6ZN1eWA398JgdLipnUfDhZOoo7d1WkJIpaM,5755
 exllamav2/exllamav2_ext/cuda/quant/qdq_5.cuh,sha256=lc4Hjp-vTdbOw02TlDy9YmkAgd8YRTKwhUtu4anUewI,7342
 exllamav2/exllamav2_ext/cuda/quant/qdq_6.cuh,sha256=ZpysJDGBCUNxbON8W_V3eFHIeYZLvQxmwxm1y2_7zhI,958
 exllamav2/exllamav2_ext/cuda/quant/qdq_8.cuh,sha256=YvJHf4kOHMOoXbI-hoRZt-Q0I36P7n7FCsKn--4dWQE,643
 exllamav2/exllamav2_ext/cuda/quant/qdq_util.cuh,sha256=dnDNK0dfh7QzfsqOwXBPR4B0tDzAwBjEjkB5gNB2P98,1272
 exllamav2/generator/__init__.py,sha256=FLfkwF1CqR4Ztas6fi0gaXmgNXpJLl9p8Li7nkn-GXA,235
 exllamav2/generator/base.py,sha256=ypFjc5vhirEgKmVG1yXeYnj_laE43nVZUxnsbT38OzA,4215
-exllamav2/generator/sampler.py,sha256=7qK4K-huRUH8J47msdzcExbiGOsBFHi9GFpY_fkzCrs,5963
-exllamav2/generator/streaming.py,sha256=RdXFDN-afyz9G20vZHGpbbRRIJtwv0wGJTdKvYNkaSU,13294
+exllamav2/generator/sampler.py,sha256=jt9I7nLv5l4I8eUlIN5BKf4psLuAIdNlRxJbS7lId_s,6126
+exllamav2/generator/streaming.py,sha256=masieP7z3_q8kl6plBBrJEHyRbhYFt4U10xpKIWjOfQ,13303
 exllamav2/generator/filters/__init__.py,sha256=zWScNP__vx1kjVAnNOzeM94IrkH1Kr3bhsAJYO2qmJQ,173
 exllamav2/generator/filters/base.py,sha256=dduBRlpCjY4j0Q0OYpapkSsDnr8fjauoa2jubnluSXQ,592
 exllamav2/generator/filters/select.py,sha256=7wsSq6L8kd2xTVWJ8NVfTi2rspiW1TK_bPEwX9Ta4BY,3319
 exllamav2/server/__init__.py,sha256=FTZeAX4gKfoZ4CMB_Yz6RJWzUUD-NskeVvfQIbodOAU,107
 exllamav2/server/websocket.py,sha256=9j9LSVLhBDeLBnEePFidwKwHTRnawaJojajVWCx-PpY,1286
 exllamav2/server/websocket_actions.py,sha256=3yhrExAGoUJrWnAJrGMm7fD59YDXwkNq0zbucH8F_40,7437
-exllamav2-0.0.8.dist-info/LICENSE,sha256=GEfg4GmBQu1DR8FEGp-oHI-93USx2LvNXjZH-ZF1nX8,1035
-exllamav2-0.0.8.dist-info/METADATA,sha256=2cj9JuwARKT4w83AvFMe_QAOf13QCGsp1kk1hu2tlUY,400
-exllamav2-0.0.8.dist-info/WHEEL,sha256=Xo9-1PvkuimrydujYJAjF7pCkriuXBpUPEjma1nZyJ0,92
-exllamav2-0.0.8.dist-info/top_level.txt,sha256=zHcNv9GI63f6FSZ1gBE6rZUoFLz6jTBuX2RjL8_6H0g,10
-exllamav2-0.0.8.dist-info/RECORD,,
+exllamav2-0.0.9.dist-info/LICENSE,sha256=GEfg4GmBQu1DR8FEGp-oHI-93USx2LvNXjZH-ZF1nX8,1035
+exllamav2-0.0.9.dist-info/METADATA,sha256=u8109BAE0YvV7MFrFo8Z1U7yHiZ3ZYyaHTwmATLTRj8,406
+exllamav2-0.0.9.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+exllamav2-0.0.9.dist-info/top_level.txt,sha256=zHcNv9GI63f6FSZ1gBE6rZUoFLz6jTBuX2RjL8_6H0g,10
+exllamav2-0.0.9.dist-info/RECORD,,
```

